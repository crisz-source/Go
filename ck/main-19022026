package main

import (
    "fmt"
    "os"
    "os/exec"

    "github.com/spf13/cobra"
    "gopkg.in/yaml.v3"
)

// Variavel para flags
var namespace string

// Comando raiz
var rootCmd = &cobra.Command{
    Use:   "ck",
    Short: "CLI para troubleshooting Kubernetes",
    Long:  "ck e uma ferramenta de linha de comando para facilitar troubleshooting no Kubernetes.",
}

// Comando version
var versionCmd = &cobra.Command{
    Use:   "version",
    Short: "Mostra a versao do ck",
    Run: func(cmd *cobra.Command, args []string) {
        fmt.Println("ck version 0.1.0")
    },
}

// Comando pods - lista pods com problema
var podsCmd = &cobra.Command{
    Use:   "pods",
    Short: "Lista pods com problema",
    Run: func(cmd *cobra.Command, args []string) {
        listProblematicPods()
    },
}

// Estrutura para parsear o YAML do kubectl
type PodList struct {
    Items []Pod `yaml:"items"`
}

type Pod struct {
    Metadata struct {
        Name      string `yaml:"name"`
        Namespace string `yaml:"namespace"`
    } `yaml:"metadata"`
    Status struct {
        Phase             string `yaml:"phase"`
        ContainerStatuses []struct {
            Name         string `yaml:"name"`
            Ready        bool   `yaml:"ready"`
            RestartCount int    `yaml:"restartCount"`
            State        struct {
                Waiting struct {
                    Reason string `yaml:"reason"`
                } `yaml:"waiting"`
            } `yaml:"state"`
        } `yaml:"containerStatuses"`
    } `yaml:"status"`
}

func listProblematicPods() {
    // Monta os argumentos do kubectl
    var args []string
    if namespace == "" {
        args = []string{"get", "pods", "-A", "-o", "yaml"}
    } else {
        args = []string{"get", "pods", "-n", namespace, "-o", "yaml"}
    }

    // Executa kubectl get pods com output YAML
    out, err := exec.Command("kubectl", args...).Output()
    if err != nil {
        fmt.Println("Erro ao executar kubectl:", err)
        return
    }

    // Parseia o YAML
    var podList PodList
    err = yaml.Unmarshal(out, &podList)
    if err != nil {
        fmt.Println("Erro ao parsear YAML:", err)
        return
    }

    // Filtra e mostra pods com problema
    fmt.Println("NAMESPACE\t\tNAME\t\t\t\t\tSTATUS")
    fmt.Println("---------\t\t----\t\t\t\t\t------")

    problemCount := 0
    for _, pod := range podList.Items {
        status := pod.Status.Phase
        hasProblem := false

        // Verifica se nao esta Running
        if status != "Running" && status != "Succeeded" {
            hasProblem = true
        }

        // Verifica containers com problema
        for _, cs := range pod.Status.ContainerStatuses {
            if cs.State.Waiting.Reason != "" {
                status = cs.State.Waiting.Reason
                hasProblem = true
            }
            if cs.RestartCount > 5 {
                status = fmt.Sprintf("%s (restarts: %d)", status, cs.RestartCount)
                hasProblem = true
            }
        }

        if hasProblem {
            fmt.Printf("%s\t\t%s\t\t%s\n", pod.Metadata.Namespace, pod.Metadata.Name, status)
            problemCount++
        }
    }

    fmt.Println("---------")
    fmt.Printf("Total: %d pods com problema\n", problemCount)
}

func init() {
    rootCmd.AddCommand(versionCmd)
    rootCmd.AddCommand(podsCmd)

    // Registra a flag -n / --namespace no comando pods 
    podsCmd.Flags().StringVarP(&namespace, "namespace", "n", "", "Filtrar por namespace")
}

func main() {
    if err := rootCmd.Execute(); err != nil {
        fmt.Println(err)
        os.Exit(1)
    }
}
